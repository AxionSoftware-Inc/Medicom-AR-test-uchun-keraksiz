<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lite Navigatsiya (3DoF)</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

    <style>
        /* --- ASOSIY UI --- */
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; }

        /* Video Fon */
        #bg-video {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: -2;
        }

        /* UI Konteyner */
        #ui-container {
            position: fixed; inset: 0; z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: none;
        }
        #ui-container > * { pointer-events: auto; }

        /* Start Ekrani */
        #start-screen {
            background: rgba(20, 30, 45, 0.95); backdrop-filter: blur(15px);
            padding: 30px; border-radius: 24px; text-align: center; color: white;
            border: 1px solid rgba(255, 255, 255, 0.1); width: 85%; max-width: 400px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; align-items: center;
        }

        h1 { margin: 0; font-size: 1.6rem; color: #00d2ff; }

        /* --- VIZIR (QR RAMKA) --- */
        .qr-frame {
            width: 220px; height: 220px;
            border: 2px solid rgba(0, 210, 255, 0.6); border-radius: 20px;
            margin: 25px 0; position: relative;
            background: rgba(0, 210, 255, 0.03);
            box-shadow: 0 0 30px rgba(0, 210, 255, 0.1);
            display: flex; align-items: center; justify-content: center;
        }
        .qr-frame::after { content: '+'; font-size: 50px; color: rgba(0, 210, 255, 0.4); font-weight: 100; }
        
        .qr-corner {
            position: absolute; width: 25px; height: 25px;
            border-color: #fff; border-style: solid;
        }
        .tl { top: -2px; left: -2px; border-width: 4px 0 0 4px; border-radius: 12px 0 0 0; }
        .tr { top: -2px; right: -2px; border-width: 4px 4px 0 0; border-radius: 0 12px 0 0; }
        .bl { bottom: -2px; left: -2px; border-width: 0 0 4px 4px; border-radius: 0 0 0 12px; }
        .br { bottom: -2px; right: -2px; border-width: 0 4px 4px 0; border-radius: 0 0 12px 0; }

        .btn-start {
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            border: none; padding: 18px 0; color: white;
            font-size: 1.2rem; font-weight: bold; border-radius: 50px;
            cursor: pointer; width: 100%; box-shadow: 0 10px 20px rgba(0, 210, 255, 0.2);
        }
        .btn-start:active { transform: scale(0.97); }

        /* Ro'yxat */
        #room-list-container {
            display: none; width: 90%; max-height: 60vh; overflow-y: auto;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px);
            border-radius: 20px; padding: 15px; border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .room-item {
            background: rgba(255, 255, 255, 0.05); padding: 18px; margin-bottom: 12px;
            border-radius: 16px; color: white; cursor: pointer; border: 1px solid transparent;
        }
        .room-item:active { background: #00d2ff; color: #000; }

        /* Hint & Reset */
        #nav-hint-box {
            display: none; position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 15px;
            text-align: center; color: white; border: 1px solid rgba(255,255,255,0.2); z-index: 1000;
        }

        #btn-reset {
            display: none; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #ff4444; color: white; padding: 12px 30px; border: none;
            border-radius: 30px; font-weight: bold; z-index: 1000; cursor: pointer;
        }

        /* A-Scene shaffof bo'lishi shart! */
        a-scene {
            display: block; position: relative; height: 100vh; width: 100%; z-index: 1;
            background: transparent !important;
        }
    </style>
</head>

<body>
    <video id="bg-video" autoplay playsinline muted></video>

    <div id="ui-container">
        <div id="start-screen">
            <h1>Lite Navigatsiya</h1>
            <p style="color:#aaa; margin-top:5px;">Kuchsiz telefonlar uchun</p>
            
            <div class="qr-frame">
                <div class="qr-corner tl"></div>
                <div class="qr-corner tr"></div>
                <div class="qr-corner bl"></div>
                <div class="qr-corner br"></div>
            </div>

            <p style="font-size:0.95rem; color:#ffd700; margin:0 0 20px 0; line-height:1.5;">
                Telefonni tekis tutib, QR kodni ramka ichiga to'g'rilang va tugmani bosing.
            </p>

            <button class="btn-start" id="start-btn">KAMERANI YOQISH</button>
        </div>

        <div id="room-list-container">
            <h3 style="text-align:center; color:white; margin:0 0 15px 0;">Manzilni tanlang:</h3>
            <div id="room-list"></div>
        </div>
    </div>

    <div id="nav-hint-box">
        <span id="nav-hint-text" style="font-weight:bold; font-size:1.1rem; color:#ffd700"></span>
    </div>

    <button id="btn-reset" onclick="resetApp()">Menyuga qaytish</button>

    <a-scene vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false"
        renderer="alpha: true; antialias: true; colorManagement: true;" style="background: transparent;">

        <a-camera id="cam" position="0 1.6 0" look-controls="enabled: true; touchEnabled: false; mouseEnabled: false;"></a-camera>
        <a-entity id="world-root" position="0 0 0"></a-entity>
    </a-scene>

    <script>
        // --- SOZLAMALAR ---
        const urlParams = new URLSearchParams(window.location.search);
        const currentFloor = urlParams.get('floor') || "1";

        // Elementlar
        const startScreen = document.getElementById('start-screen');
        const roomListContainer = document.getElementById('room-list-container');
        const roomList = document.getElementById('room-list');
        const btnReset = document.getElementById('btn-reset');
        const worldRoot = document.getElementById('world-root');
        const videoElement = document.getElementById('bg-video');
        const navHintBox = document.getElementById('nav-hint-box');
        const navHintText = document.getElementById('nav-hint-text');

        // 1. MA'LUMOTNI YUKLASH (Cache busting bilan)
        fetch('../floors.json?v=' + Date.now())
            .then(res => res.json())
            .then(data => {
                const rooms = data[currentFloor];
                if (rooms) renderRooms(rooms);
                else roomList.innerHTML = '<div style="color:white; text-align:center">Ma\'lumot topilmadi</div>';
            })
            .catch(err => {
                console.error(err);
                roomList.innerHTML = '<div style="color:red; text-align:center">Fayl topilmadi</div>';
            });

        function renderRooms(rooms) {
            roomList.innerHTML = '';
            rooms.forEach(room => {
                const div = document.createElement('div');
                div.className = 'room-item';
                
                // Matnlarni to'g'irlash
                const isLeft = room.corridor === 'left';
                const dirText = isLeft ? "Chap yo'lak" : "O'ng yo'lak";

                div.innerHTML = `<b>Xona ${room.id}</b><br><small>${dirText}, ${room.x}m</small>`;
                div.onclick = () => startNavigation(room);
                roomList.appendChild(div);
            });
        }

        // 2. KAMERA VA SENSORLARNI ISHGA TUSHIRISH
        document.getElementById('start-btn').onclick = async () => {
            // A. Kamerani yoqish
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoElement.srcObject = stream;
            } catch (err) {
                alert("Kameraga ruxsat berilmadi! Sozlamalardan yoqing.");
                return;
            }

            // B. Sensorlarga ruxsat (iOS 13+ uchun juda muhim)
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission !== 'granted') {
                        alert("Diqqat: Sensorga ruxsat berilmasa, kompas ishlamaydi!");
                    }
                } catch (e) {
                    console.log(e);
                }
            }

            // UI almashinuvi
            startScreen.style.display = 'none';
            roomListContainer.style.display = 'block';
        };

        // 3. NAVIGATSIYA CHIZMASI
        function startNavigation(room) {
            roomListContainer.style.display = 'none';
            btnReset.style.display = 'block';
            navHintBox.style.display = 'block';

            worldRoot.innerHTML = ''; // Tozalash

            const isLeft = room.corridor === 'left';
            
            // Hint Matni
            const turnText = isLeft ? "CHAPGA BURILING" : "O'NGGA BURILING";
            navHintText.innerText = `${turnText} VA YURING`;

            // A. STRELKALAR (Infinite Loop Animatsiyasi)
            // 3DoF da userning yurgani bilinmaydi, shuning uchun strelkalar tinimsiz userga qarab keladi (yoki uzoqlashadi).
            // Bu "yurish kerak" degan illyuziyani beradi.
            
            const distance = room.x; // Taxminiy vizual uzunlik

            for (let i = 1.0; i < distance; i += 1.5) {
                const arrowGroup = document.createElement('a-entity');
                // Boshlang'ich pozitsiya
                arrowGroup.setAttribute('position', `0 -0.8 -${i}`);

                // Animatsiya: Oldinga yurish effekti
                arrowGroup.setAttribute('animation', `
                    property: position; 
                    to: 0 -0.8 -${i + 2}; 
                    dur: 2000; 
                    easing: linear; 
                    loop: true
                `);

                const arrow = document.createElement('a-entity');
                // Uchburchak
                arrow.setAttribute('geometry', 'primitive: triangle; vertexA: 0 0 0; vertexB: -0.2 0 0.3; vertexC: 0.2 0 0.3');
                arrow.setAttribute('material', 'color: #00d2ff; shader: flat; transparent: true; opacity: 0.8; side: double');
                
                // To'g'ri burish
                arrow.setAttribute('rotation', '-90 0 180');

                arrowGroup.appendChild(arrow);
                worldRoot.appendChild(arrowGroup);
            }

            // B. MANZIL BELGISI
            // Lite versiyada biz eshikni aniq joyini ko'rsata olmaymiz (chunki masofa o'lchanmaydi).
            // Shuning uchun shunchaki "O'ngda" yoki "Chapda" ekanligini bildiruvchi belgi qo'yamiz.
            
            let doorSide = 0;
            // Agar Chap yo'lak bo'lsa va Eshik Chapda bo'lsa -> User uchun bu O'ng qo'l (Startga nisbatan Orqa)
            // Bu juda chalkash 3DoF da. Eng yaxshisi:
            // Shunchaki to'g'rida belgi ko'rsatamiz.
            
            const pin = document.createElement('a-entity');
            pin.setAttribute('position', `0 -0.5 -${distance}`); // To'g'rida, uzoqda

            const cone = document.createElement('a-cone');
            cone.setAttribute('color', 'lime');
            cone.setAttribute('radius-bottom', '0.05');
            cone.setAttribute('radius-top', '0.4');
            cone.setAttribute('height', '1');
            cone.setAttribute('position', '0 1 0');
            // Sakrash
            cone.setAttribute('animation', 'property: position; from: 0 1 0; to: 0 1.3 0; dir: alternate; loop: true; dur: 800');

            pin.appendChild(cone);

            // Xona nomi
            const text = document.createElement('a-text');
            text.setAttribute('value', `Xona ${room.id}`);
            text.setAttribute('align', 'center');
            text.setAttribute('scale', '5 5 5');
            text.setAttribute('position', `0 2.5 0`);
            text.setAttribute('color', '#fff');

            pin.appendChild(text);
            worldRoot.appendChild(pin);
        }

        // 4. QAYTA BOSHLASH
        window.resetApp = function () {
            worldRoot.innerHTML = '';
            btnReset.style.display = 'none';
            navHintBox.style.display = 'none';
            roomListContainer.style.display = 'block';
        }
    </script>
</body>
</html>