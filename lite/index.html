<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lite Navigatsiya (3DoF)</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
            background: #000;
        }

        /* 1. VIDEO FON (Eng orqada) */
        #bg-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -2;
        }

        /* 2. UI QATLAMI */
        #ui-container {
            position: fixed;
            inset: 0;
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        #ui-container>* {
            pointer-events: auto;
        }

        /* Start Ekrani */
        #start-screen {
            background: rgba(20, 20, 30, 0.9);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 85%;
            max-width: 400px;
        }

        .btn-start {
            background: #00d2ff;
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 50px;
            margin-top: 20px;
            cursor: pointer;
            width: 100%;
            color: #000;
        }

        /* Xonalar Ro'yxati */
        #room-list-container {
            display: none;
            width: 90%;
            max-height: 60vh;
            overflow-y: auto;
            background: rgba(10, 20, 30, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
        }

        .room-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .room-item:active {
            background: #00d2ff;
            color: #000;
        }

        /* Menyuga qaytish tugmasi */
        #btn-reset {
            display: none;
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4444;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            z-index: 1000;
        }

        /* A-Scene shaffof bo'lishi shart! */
        a-scene {
            display: block;
            position: relative;
            height: 100vh;
            width: 100%;
            z-index: 1;
            background: transparent !important;
        }
    </style>
</head>

<body>
    <video id="bg-video" autoplay playsinline muted></video>

    <div id="ui-container">
        <div id="start-screen">
            <h1>Lite Navigatsiya</h1>
            <p>Kuchsiz telefonlar uchun</p>
            <div style="background: rgba(255,215,0,0.2); border-radius:10px; padding:10px; margin-top:15px;">
                <p style="font-size: 0.9rem; color: #ffd700; margin: 0;">
                    ⚠️ <b>MUHIM:</b> QR kodga va yo'lakka qarab turing, keyin "Boshlash"ni bosing.
                </p>
            </div>
            <button class="btn-start" id="start-btn">KAMERANI YOQISH</button>
        </div>

        <div id="room-list-container">
            <h3 style="text-align:center; color:white; margin:0 0 15px 0;">Manzilni tanlang:</h3>
            <div id="room-list"></div>
        </div>
    </div>

    <div id="nav-hint-box"
        style="display:none; position:fixed; bottom:80px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); padding:10px 20px; border-radius:15px; text-align:center; color:white; border:1px solid rgba(255,255,255,0.2); z-index:1000;">
        <span id="nav-hint-text" style="font-weight:bold; font-size:1.1rem; color:#ffd700"></span>
    </div>

    <button id="btn-reset" onclick="resetApp()">Menyuga qaytish</button>

    <a-scene vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false"
        renderer="alpha: true; antialias: true; colorManagement: true;" style="background: transparent;">

        <a-camera id="cam" position="0 1.6 0"
            look-controls="enabled: true; touchEnabled: false; mouseEnabled: false;"></a-camera>
        <a-entity id="world-root" position="0 0 0"></a-entity>

    </a-scene>

    <script>
        // --- SOZLAMALAR ---
        const urlParams = new URLSearchParams(window.location.search);
        const currentFloor = urlParams.get('floor') || "1";

        // Elementlar
        const startScreen = document.getElementById('start-screen');
        const roomListContainer = document.getElementById('room-list-container');
        const roomList = document.getElementById('room-list');
        const btnReset = document.getElementById('btn-reset');
        const worldRoot = document.getElementById('world-root');
        const videoElement = document.getElementById('bg-video');
        const navHintBox = document.getElementById('nav-hint-box');
        const navHintText = document.getElementById('nav-hint-text');

        // 1. MA'LUMOTNI YUKLASH
        fetch('../floors.json?v=' + Date.now()) // Keshni oldini olish
            .then(res => res.json())
            .then(data => {
                const rooms = data[currentFloor];
                if (rooms) renderRooms(rooms);
                else roomList.innerHTML = '<div style="color:white; text-align:center">Ma\'lumot topilmadi</div>';
            })
            .catch(err => {
                console.error(err);
                roomList.innerHTML = '<div style="color:red; text-align:center">Fayl topilmadi</div>';
            });

        function renderRooms(rooms) {
            roomList.innerHTML = '';
            rooms.forEach(room => {
                const div = document.createElement('div');
                div.className = 'room-item';

                // Eski va yangi json formatini qo'llab-quvvatlash
                const isLeft = (room.corridor === 'left' || room.corridorDir === 'left');
                const dirText = isLeft ? "Chap yo'lak" : "O'ng yo'lak";

                div.innerHTML = `<b>Xona ${room.id}</b><br><small>${dirText}, ${room.x}m</small>`;
                div.onclick = () => startNavigation(room);
                roomList.appendChild(div);
            });
        }

        // 2. KAMERA VA SENSORLARNI ISHGA TUSHIRISH
        document.getElementById('start-btn').onclick = async () => {
            // A. Kamerani yoqish (Video fon uchun)
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                videoElement.srcObject = stream;
            } catch (err) {
                alert("Kameraga ruxsat berilmadi!");
                return;
            }

            // B. Sensorlarga ruxsat (iOS 13+)
            // A-Frame look-controls buni o'zi so'raydi, lekin biz baribir check qilamiz
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission !== 'granted') alert("Sensorga ruxsat kerak!");
                } catch (e) {
                    console.log(e);
                }
            }

            // UI almashinuvi
            startScreen.style.display = 'none';
            roomListContainer.style.display = 'block';
        };

        // 3. NAVIGATSIYA CHIZMASI
        function startNavigation(room) {
            roomListContainer.style.display = 'none';
            btnReset.style.display = 'block';
            navHintBox.style.display = 'block';

            worldRoot.innerHTML = ''; // Tozalash

            // Yo'nalish aniqlash
            const isLeft = (room.corridor === 'left' || room.corridorDir === 'left');
            const turnText = isLeft ? "CHAPGA BURILING" : "O'NGGA BURILING";
            navHintText.innerText = `${turnText} VA YURING`;
            navHintText.style.color = "#ffd700";

            // Biz user QR kodga qarab turibdi deb hisoblaymiz.
            // Demak "Oldinga" bu -Z o'qi. 
            // Strelkalarni chizamiz.

            const distance = room.x;

            // A. Strelkalar (Yurish effekti bilan)
            // 3DoF bo'lgani uchun, user yursa ham strelka yaqinlashmaydi.
            // Shuning uchun strelkalarni o'zini userga qarab yurgizamiz (Infinite loop animation).

            // A. Strelkalar (Yurish effekti bilan) - RASMSIZ VERSIYA
            for (let i = 1.0; i < distance; i += 1.5) {
                const arrowGroup = document.createElement('a-entity');
                arrowGroup.setAttribute('position', `0 -0.8 -${i}`);

                // Animatsiya
                arrowGroup.setAttribute('animation', `
        property: position; 
        to: 0 -0.8 -${i - 1.5}; 
        dur: 1500; 
        easing: linear; 
        loop: true
    `);

                const arrow = document.createElement('a-entity');
                // Uchburchak chizamiz (Rasm kerak emas)
                arrow.setAttribute('geometry', 'primitive: triangle; vertexA: 0 0 0; vertexB: -0.2 0 0.3; vertexC: 0.2 0 0.3');
                arrow.setAttribute('material', 'color: #00d2ff; shader: flat; transparent: true; opacity: 0.8; side: double');

                // Uchburchakni to'g'ri burish (Uchi oldinga)
                arrow.setAttribute('rotation', '-90 0 180');

                arrowGroup.appendChild(arrow);
                worldRoot.appendChild(arrowGroup);
            }

            // B. Manzil belgisi
            // Eshik chapdami yoki o'ngda?
            // User QRga qarab turibdi (-Z).
            // Chap yo'lak (-X) bo'lsa:
            // Eshik Left -> +Z (Userning orqasi-chapi)
            // Eshik Right -> -Z (Userning oldi-chapi) -- BU MURAKKAB

            // LITE VERSIYA UCHUN ODDİY YECHİM:
            // Biz shunchaki masofa tugaganda katta belgi qo'yamiz.
            // Eshik tomonini ko'rsatish uchun belgi biroz o'ng yoki chapga suriladi.

            const doorSide = (room.door === 'left' || room.side === 'left') ? -1.5 : 1.5;

            const pin = document.createElement('a-entity');
            pin.setAttribute('position', `${doorSide} -0.5 -${distance}`);

            const cone = document.createElement('a-cone');
            cone.setAttribute('color', 'lime');
            cone.setAttribute('radius-bottom', '0.02');
            cone.setAttribute('radius-top', '0.3');
            cone.setAttribute('height', '0.8');
            cone.setAttribute('position', '0 1 0');
            // Tepaga pastga sakrash
            cone.setAttribute('animation', 'property: position; from: 0 1 0; to: 0 1.2 0; dir: alternate; loop: true; dur: 800');

            pin.appendChild(cone);

            // Manzil yozuvi
            const text = document.createElement('a-text');
            text.setAttribute('value', `Xona ${room.id}`);
            text.setAttribute('align', 'center');
            text.setAttribute('scale', '4 4 4');
            text.setAttribute('position', `0 2 0`);
            text.setAttribute('color', '#fff');

            pin.appendChild(text);
            worldRoot.appendChild(pin);
        }

        // 4. QAYTA BOSHLASH
        window.resetApp = function () {
            worldRoot.innerHTML = '';
            btnReset.style.display = 'none';
            navHintBox.style.display = 'none';
            roomListContainer.style.display = 'block';
        }
    </script>
</body>

</html>